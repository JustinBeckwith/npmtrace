<html>
<head>
<link rel="import" href="/trace_viewer_full.html">
<link rel="stylesheet" href="/package.css">
</head>
<body>
<header>
  <span><a href="/">npm.trace</a></span>
  <form id="form"><input type="search" id="search" autofocus></form>
</header>
<div id="super">
  <div id="main"></div>
  <div id="spinframe">
    <div class="spinner">
      <div class="double-bounce1"></div>
      <div class="double-bounce2"></div>
    </div>
    <div id="message"></div>
  </div>
</div>
<script>
  const form = document.getElementById('form');
  const search = document.getElementById('search');
  const spinny = document.getElementById('spinframe');
  const message = document.getElementById('message');
  const messages = [
    'this could take a little while.',
    'npm.trace needs to install the module, and profile it',
    'for some modules, this can take a little time',
    'after that, we can read the result from a cache',
    'you should checkout out npm.im/require-so-slow to learn more',
    'we made this at google to make it easier to profile cold start',
    'if it has taken this long, something probably went wrong',
    'can you make sure the npm module actually exists?'
  ];
  let messageIdx = 0;
  const messageInterval = setInterval(() => {
    if (messageIdx < messages.length) {
      message.innerText = messages[messageIdx];
      messageIdx++;
    }
  }, 4000);
  const container = document.createElement('track-view-container');
  container.id = 'track_view_container';
  viewer = document.createElement('tr-ui-timeline-view');
  viewer.track_view_container = container;
  Polymer.dom(viewer).appendChild(container);
  viewer.id = 'trace-viewer';
  viewer.globalMode = true;
  Polymer.dom(document.getElementById('main')).appendChild(viewer);
  const model = new tr.Model();
  async function getTrace() {
    const url = `/api${window.location.pathname}`;
    const res = await fetch(url);
    const data = await res.json();
    const i = new tr.importer.Import(model);
    await i.importTracesWithProgressDialog([data]);
    viewer.model = model;
    clearInterval(messageInterval);
    spinny.classList.add('fadeout');
    setTimeout(() => {
      spinny.style.display = 'none';
    }, 1000);
  }
  getTrace().catch(console.error);

  form.onsubmit = e => {
    if (search.value !== '') {
      window.location.href = `${window.location.origin}/packages/${search.value}`;
    }
    e.preventDefault();
  };
  const packageName = window.location.pathname.split('/').filter(x => !!x).slice(1, -1).join('/');
  search.placeholder = packageName;
</script>
</body>
</html>
